package economic;

import java.net.MalformedURLException;
import java.net.URL;
import java.time.Duration;
import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.remote.RemoteWebDriver;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.Select;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.openqa.selenium.JavascriptExecutor;
import org.testng.annotations.AfterMethod;
import org.testng.annotations.BeforeMethod;
import org.testng.annotations.Test;
import utils.EventHandler;
import org.openqa.selenium.support.events.WebDriverListener;
import org.openqa.selenium.support.events.EventFiringDecorator;

public class TestEconomic {
    public static WebDriver driver;
    private WebDriverWait wait;
    public final int IMPLICIT_WAIT_TIME = 10;
    public final int PAGE_LOAD_TIME = 10;

    @BeforeMethod
    public void beforeMethod() throws MalformedURLException {
        ChromeOptions chromeOptions = new ChromeOptions();
        driver = new RemoteWebDriver(new URL("http://localhost:4444"), chromeOptions);
        driver.manage().window().maximize();
        wait = new WebDriverWait(driver, Duration.ofSeconds(20));
        driver.get("https://economictimes.indiatimes.com/et-now/results");
        WebDriverListener listener = new EventHandler();
        driver = new EventFiringDecorator<>(listener).decorate(driver);
        System.out.println("Browser initialized");
    }

    @Test
    public void economic() throws Exception {
        driver.findElement(By.xpath("//*[@id=\"topnav\"]/div[10]/a")).click();
        Thread.sleep(10000);
        JavascriptExecutor js = (JavascriptExecutor) driver;
        js.executeScript("window.scrollBy(0,600)", "");
        driver.findElement(By.id("amcSelection")).click();
        Thread.sleep(5000);
        Select amcSelect = new Select(driver.findElement(By.id("amcSelection")));
        amcSelect.selectByVisibleText("Canara Robeco");
        Thread.sleep(3000);
        driver.findElement(By.id("schemenm")).click();
        Thread.sleep(5000);
        Select schemeSelect = new Select(driver.findElement(By.id("schemenm")));
        schemeSelect.selectByVisibleText("Canara Robeco Bluechip Equity Direct-G");
        Thread.sleep(1000);

        // Handling overlay or ad
        try {
            WebElement adCloseButton = driver.findElement(By.cssSelector("div#ad_position_box")); // Adjust the selector as needed
            if (adCloseButton.isDisplayed()) {
                System.out.println("Closing the ad...");
                ((JavascriptExecutor) driver).executeScript("arguments[0].style.visibility='hidden'", adCloseButton);
            }
        } catch (Exception e) {
            System.out.println("Ad close button not found or already closed.");
        }

        // Use JavaScript to click if the standard click fails
        WebElement getDetailsButton = driver.findElement(By.id("getDetails"));
        try {
            getDetailsButton.click();
        } catch (Exception e) {
            ((JavascriptExecutor) driver).executeScript("arguments[0].click();", getDetailsButton);
        }

        Thread.sleep(15000);

        String currentTab = driver.getWindowHandle();
        for (String tab : driver.getWindowHandles()) {
            if (!tab.equals(currentTab)) {
                driver.switchTo().window(tab);
                break;
            }
        }

        WebElement dropdownContainer = driver.findElement(By.xpath("/html/body/main/div[10]/section[1]/div/div[2]/div[1]/div[2]/ul/li/span"));
        dropdownContainer.click();

        WebElement options = dropdownContainer.findElement(By.xpath("/html/body/main/div[10]/section[1]/div/div[2]/div[1]/div[2]/ul/li/ul/li[1]"));
        options.click();
        Thread.sleep(2000);
        WebElement container = driver.findElement(By.xpath("/html/body/main/div[10]/section[1]/div/div[2]/div[1]/div[3]/ul/li/span"));
        container.click();

        WebElement option = dropdownContainer.findElement(By.xpath("/html/body/main/div[10]/section[1]/div/div[2]/div[1]/div[3]/ul/li/ul/li[3]/span"));
        option.click();

        Thread.sleep(2000);

        WebElement contain = driver.findElement(By.xpath("/html/body/main/div[10]/section[1]/div/div[2]/div[1]/div[4]/ul/li/span"));
        contain.click();

        WebElement opt = dropdownContainer.findElement(By.xpath("/html/body/main/div[10]/section[1]/div/div[2]/div[1]/div[4]/ul/li/ul/li[4]/span"));
        opt.click();

        WebElement returns = driver.findElement(By.xpath("/html/body/main/div[10]/section[3]/div/ul/li[2]"));
        returns.click();
        Thread.sleep(5000);

        WebElement printthis = driver.findElement(By.xpath("/html/body/main/div[10]/section[5]/div/div[1]/section[1]/div[2]/div[2]/ul/li[1]/table/tbody/tr[1]"));
        System.out.println(printthis.getText());
    }

    @AfterMethod
    public void afterMethod() {
        driver.quit();
    }
}